{% extends "base_table.html" %}

{% block title %}Event Detail - {{ event.title }}{% endblock title %}

{% block js %}
{{ block.super }}

  <script>
    $(document).ready( function() {
    {% for period in event.period_set.all %}
        var table{{period.position}} = $("#dTbl{{period.position}}").DataTable( {
            dom: "Bfrtip",
            responsive: true,
            select: "single",
            altEditor: true,
            paging:   false,
            info:     false,
            order: [[ 0, "asc" ]],
            columnDefs: [
                { responsivePriority: 1, targets: 0 },
                { responsivePriority: 2, targets: 1 },
                { responsivePriority: 3, targets: [2, 3]},
                { visible: false, targets: [5, 6, 7, 8, 9]},
            ],
            columns: [
                { 'data': "name" },
                { 'data': "en_route_at" },
                { 'data': "return_home_at" },
                { 'data': "signed_in_at" },
                { 'data': "signed_out_at" },
                { 'data': "ahc" },
                { 'data': "ol" },
                { 'data': "id", type: "readonly" },
                { 'data': "member", type: "readonly" },
                { 'data': "period", type: "readonly" },
            ],
            buttons: [
                {
                    text: '<i class="fa fa-bullhorn"></i> Page',
                    extend: "collection",
                    autoClose: true,
                    buttons: [
                        {
                            text: '<i class="fa fa-hourglass-start"></i> Heads Up',
                            action: function ( e, dt, node, config ) {
                                location.href='{% url "message:message_add" %}?period={{ period.id }}&period_format=invite';
                            }
                        },
                        {
                            text: '<i class="fa fa-calendar-check-o"></i> Are you available',
                            action: function ( e, dt, node, config ) {
                                location.href='{% url "message:message_add" %}?period={{ period.id }}&period_format=invite';
                            }
                        },
                        {
                            text: '<i class="fa fa-clock-o"></i> Have you left',
                            action: function ( e, dt, node, config ) {
                                if (dt.rows().count() == 0) 
                                    alert('Add members to period before paging them');
                                else
                                    location.href='{% url "message:message_add" %}?period={{ period.id }}&period_format=leave';
                            }
                        },
                        {
                            text: '<i class="fa fa-clock-o"></i> Are you home',
                            action: function ( e, dt, node, config ) {
                                if (dt.rows().count() == 0) 
                                    alert('Add members to period before paging them');
                                else
                                    location.href='{% url "message:message_add" %}?period={{ period.id }}&period_format=return';
                            }
                        },
                        {
                            text: '<i class="fa fa-wrench"></i> Test',
                            action: function ( e, dt, node, config ) {
                                if (dt.rows().count() == 0) 
                                    alert('Add members to period before paging them');
                                else
                                    location.href='{% url "message:message_add" %}?period={{ period.id }}&period_format=test';
                            }
                        }
                    ]
                },
                {
                    text: '<i class="fa fa-address-book"></i> Add',
                    action: function ( e, dt, node, config ) {
                        location.href='{% url "event_participant_add" period.id %}?et={{period.event.title}}&eid={{event.id}}&pn={{period.position}}&pid={{period.id}}';
                    }
                },
                {
                    extend: "selected", // Bind to Selected row
                    text: '<i class="fa fa-edit"></i> Edit',
                    name: "edit"        // do not change name
                },
                {
                    extend: "selected", // Bind to Selected row
                    autoClose: true,
                    text: '<i class="fa fa-trash"></i> Delete',
                    name: "delete"      // do not change name
                },
                {
                    text: '<i class="fa fa-newspaper-o"></i> More',
                    extend: "collection",
                    autoClose: true,
                    buttons: [
                        "copy", "csv", "excel", "print", "colvis"
                    ]
                }
            ],
            onEditRow: function(dt, row, success, error) {
                CleanDate = function (d) {
                    sd = d ? d.substr(0, d.length - 9) : '';
                    return sd;
                }

                var data = row;

                // Delete values that won't be set
                delete data.member;
                for (d in data) if (data[d] == '') delete data[d];

                //FIXME: Eventual this should allow mult-row select for delete and edit
                //var members = dt.rows( { selected: true } ).data().pluck( 'Name' ).toArray();
                var id = data['id'];
                data = JSON.stringify(data);
                $.ajax({
                    'method': 'patch',
                    'contentType': 'application/json',
                    'url': '/api/edit_participants/' + id + '/',
                    'data': data,
                    success: function (r, s, m) {
                        var name = r['member']['full_name'];
                        if (r['ahc']) name += '(AHC)';
                        if (r['ol']) name += '(OL)';
                        r['name'] = name;
                        //FIXME: temporary fix until we decide on api date format
                        r['en_route_at'] = CleanDate(r['en_route_at']);
                        r['return_home_at'] = CleanDate(r['return_home_at']);
                        r['signed_in_at'] = CleanDate(r['signed_in_at']);
                        r['signed_out_at'] = CleanDate(r['signed_out_at']);
                        return success(r, s, m);
                    },
                    error: function (xhr) {
                        console.log('member edit failed');
                        console.log(xhr);
                        return error;
                    }
                })
            },
            onDeleteRow: function(dt, row, success, error) {

                var id = row[7];  //FIXME: why is this array vs dict with labels?
                
                //FIXME: Eventual this should allow mult-row select for delete and edit
                $.ajax({
                    'type': 'DELETE',
                    'contentType': 'application/json',
                    'url': '/api/participants/' + id + '/',
                    success: function (r, s, m) {
                        return success(r, s, m);
                    },
                    error: function (xhr) {
                        console.log('member delete failed');
                        console.log(xhr);
                        return error;
                    }
                })
            },
            language: {
                emptyTable: "No members added"
            },
    });
    {% endfor %}

    });

  </script>
{% endblock %}


{% block subheader %}
  <button class="navbar-toggler navbar-light bg-light" type="button"
          data-toggle="collapse" data-target="#eventMenu">
    <span class="navbar-toggler-icon"></span>
  </button>
  <strong>
    <a href='{% url "event_all" %}'> Events </a>
    > {{ event.title}} ({{ event.type }})
  </strong>
  <div class="collapse navbar-collapse" id="eventMenu">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" href='{% url "event_update" event.id %}'>
          <i class="fa fa-pencil"></i>
          Edit
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href='{% url "event_delete" event.id %}'><i class="fa fa-trash"></i> Delete</a>
      </li>
    </ul>
  </div>
{% endblock %}

  
{% block content %}
<main role="main" class="container">
  <div id="content">
    <p><strong>Description:</strong> {{ event.description }}</p>
    <p><strong>Location:</strong> {{ event.location }}</p>
    <p><strong>Leaders:</strong> {{ event.leaders }}</p>
    <p>
      <strong>Start:</strong> {{ event.start }}
      <strong>End:</strong> {{ event.finish }}
      <strong>All day:</strong> {{ event.all_day }}
      <strong>Published:</strong> {{ event.published }}
    </p>

    {% for period in event.period_set.all %}
    <a name="OP{{period.position}}"></a>
    <nav class="navbar navbar-expand-md navbar-light bg-light">
      <button class="btn navbar-btn" onclick='$("#dTbl{{period.position}}_wrapper").toggle();'>
        <i class="fa fa-area-chart"></i> OP {{period.position}}
      </button>
      
      <ul class="nav navbar-nav navbar-right">
        <li class="nav-item">
          <a  class="nav-link" href='{% url "event_period_delete" event.id period.id %}'><i class="fa fa-trash"></i> Delete OP</a>
        </li>
      </ul>
    </nav>

    <table id="dTbl{{period.position}}" class="display table-bordered nowrap table-striped" cellpadding="0" cellspacing="0" style="width:100%">
      <thead>
      <tr>
        <th>Name</th>
        <th>Left</th>
        <th>Returned</th>
        <th>Signed in</th>
        <th>Signed out</th>
        <th>ahc</th>
        <th>ol</th>
        <th>id</th>
        <th>member</th>
        <th>period</th>
      </tr>
      </thead>
      <tbody>
      {% for p in period.participant_set.all %}
      <tr>
        <td>{{ p.member }}
          {% if p.ahc %}
          (AHC)
          {% endif %}
          {% if p.ol %}
          (OL)
          {% endif %}
        </td>
        <td>{{ p.en_route_at|date:"Y-m-d\TH:m" }}</td>
	    <td>{{ p.return_home_at|date:"Y-m-d\TH:m" }}</td>
	    <td>{{ p.signed_in_at|date:"Y-m-d\TH:m" }}</td>
	    <td>{{ p.signed_out_at|date:"Y-m-d\TH:m" }}</td>
	    <td>{{ p.ahc }}</td>
	    <td>{{ p.ol }}</td>
	    <td>{{ p.id }}</td>
	    <td>{{ p.member.id }}</td>
	    <td>{{ p.period.id }}</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    {% endfor %}
  </div>

  <nav class="navbar navbar-expand-md navbar-light bg-light">
    <button class="btn navbar-btn" onclick="var n={{event.period_set.all.count}}+2; location.href='{% url "event_period_add" event.id %}#OP'+n">
      <i class="fa fa-area-chart"></i> OP Next
    </button>
  </nav>

</main> {# /.container #}
{% endblock %}
