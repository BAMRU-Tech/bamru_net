{% extends "base_table.html" %}

{% block title %}Event Detail - {{ event.title }}{% endblock title %}

{% block js %}
{{ block.super }}

  <script>
    $(document).ready( function() {
    {% for period in event.period_set.all %}
        var table{{period.position}} = $("#dTbl{{period.position}}").DataTable( {
            dom: "Bfrtip",
            responsive: true,
            select: "single",
            altEditor: true,
            paging:   false,
            info:     false,
            order: [[ 0, "asc" ]],
            columnDefs: [
                { "orderable": false, "targets": 5 },
                { responsivePriority: 1, targets: 0 },
                { responsivePriority: 2, targets: 1 },
                { responsivePriority: 3, targets: [2, 3]}
            ],
            buttons: [
                {
                    text: '<i class="fa fa-bullhorn"></i> Page',
                    extend: "collection",
                    autoClose: true,
                    buttons: [
                        {
                            text: '<i class="fa fa-hourglass-start"></i> Heads Up',
                            action: function ( e, dt, node, config ) {
                                location.href='{% url "message:message_add" %}?period={{ period.id }}&period_format=invite';
                            }
                        },
                        {
                            text: '<i class="fa fa-calendar-check-o"></i> Are you available',
                            action: function ( e, dt, node, config ) {
                                location.href='{% url "message:message_add" %}?period={{ period.id }}&period_format=invite';
                            }
                        },
                        {
                            text: '<i class="fa fa-clock-o"></i> Have you left',
                            action: function ( e, dt, node, config ) {
                                if (dt.rows().count() == 0) 
                                    alert('Add members to period before paging them');
                                else
                                    location.href='{% url "message:message_add" %}?period={{ period.id }}&period_format=leave';
                            }
                        },
                        {
                            text: '<i class="fa fa-clock-o"></i> Are you home',
                            action: function ( e, dt, node, config ) {
                                if (dt.rows().count() == 0) 
                                    alert('Add members to period before paging them');
                                else
                                    location.href='{% url "message:message_add" %}?period={{ period.id }}&period_format=return';
                            }
                        },
                        {
                            text: '<i class="fa fa-wrench"></i> Test',
                            action: function ( e, dt, node, config ) {
                                if (dt.rows().count() == 0) 
                                    alert('Add members to period before paging them');
                                else
                                    location.href='{% url "message:message_add" %}?period={{ period.id }}&period_format=test';
                            }
                        }
                    ]
                },
                {
                    text: '<i class="fa fa-address-book"></i> Add',
                    action: function ( e, dt, node, config ) {
                        location.href='{% url "event_participant_add" period.id %}?et={{period.event.title}}&eid={{event.id}}&pn={{period.position}}&pid={{period.id}}';
                    }
                },
                {
                    extend: "selected", // Bind to Selected row
                    text: '<i class="fa fa-edit"></i> Edit',
                    name: "edit"        // do not change name
                },
                {
                    extend: "selected", // Bind to Selected row
                    autoClose: true,
                    text: '<i class="fa fa-trash"></i> Delete',
                    name: "delete"      // do not change name
                },
                {
                    text: '<i class="fa fa-newspaper-o"></i> More',
                    extend: "collection",
                    autoClose: true,
                    buttons: [
                        "copy", "csv", "excel", "print", "colvis"
                    ]
                }
            ],
            onDeleteRow: function(dt, rowdata, success, error) {
                var csrftoken = getCookie('csrftoken');
                //FIXME: Eventual this should allow mult-row select for delete and edit
                //var members = dt.rows( { selected: true } ).data().pluck( 'Name' ).toArray();
                var regex = /\d+(?:\.\d+)?/;
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });
                $.ajax({
                    'type': 'DELETE',
                    'contentType': 'application/json',
                    'url': '/api/participants/2',
                    success: success,
                    error: function (xhr) {
                        console.log('member delete failed');
                        console.log(xhr);
                        return error;
                    }
                })
            },
            onEditRow: function(datatable, rowdata, success, error) {
                $.ajax({
                    // a tipycal url would be /{id} with type='POST'
                    url: url_ws_mock_ok,
                    type: 'GET',
                    data: rowdata,
                    success: success,
                    error: error
                });
            },
            language: {
                emptyTable: "No members added"
            },
    });
    {% endfor %}

    });

  </script>
{% endblock %}


{% block subheader %}
  <button class="navbar-toggler navbar-light bg-light" type="button"
          data-toggle="collapse" data-target="#eventMenu">
    <span class="navbar-toggler-icon"></span>
  </button>
  <strong>
    <a href='{% url "event_all" %}'> Events </a>
    > {{ event.title}} ({{ event.type }})
  </strong>
  <div class="collapse navbar-collapse" id="eventMenu">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" href='{% url "event_update" event.id %}'>
          <i class="fa fa-pencil"></i>
          Edit
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href='{% url "event_delete" event.id %}'><i class="fa fa-trash"></i> Delete</a>
      </li>
    </ul>
  </div>
{% endblock %}

  
{% block content %}
<main role="main" class="container">
  <div id="content">
    <p><strong>Description:</strong> {{ event.description }}</p>
    <p><strong>Location:</strong> {{ event.location }}</p>
    <p><strong>Leaders:</strong> {{ event.leaders }}</p>

    {% for period in event.period_set.all %}
    <a name="OP{{period.position}}"></a>
    <nav class="navbar navbar-expand-md navbar-light bg-light">
      <button class="btn navbar-btn" onclick='$("#dTbl{{period.position}}_wrapper").toggle();'>
        <i class="fa fa-area-chart"></i> OP {{period.position}}
      </button>
      
      <ul class="nav navbar-nav navbar-right">
        <li class="nav-item">
          <a  class="nav-link" href='{% url "event_period_delete" event.id period.id %}'><i class="fa fa-trash"></i> Delete OP</a>
        </li>
      </ul>
    </nav>

    <table id="dTbl{{period.position}}" class="display table-bordered nowrap table-striped" cellpadding="0" cellspacing="0" style="width:100%">
      <thead>
      <tr>
        <th>Name</th>
        <th>Left</th>
        <th>Returned</th>
        <th>Signed in</th>
        <th>Signed out</th>
        <th></th>
      </tr>
      </thead>
      <tbody>
      {% for participant in period.participant_set.all %}
      <tr>
        <td>{{ participant.member }}</td>
        <td>{{ participant.en_route_at }}</td>
	    <td>{{ participant.return_home_at }}</td>
	    <td>{{ participant.signed_in_at }}</td>
	    <td>{{ participant.signed_out_at }}</td>
        <td><a href='{% url "event_participant_delete" event=event.id pk=participant.id %}'>
        <i class="fa fa-trash"></i>
          </a>
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    {% endfor %}
  </div>

  <nav class="navbar navbar-expand-md navbar-light bg-light">
    <button class="btn navbar-btn" onclick="var n={{event.period_set.all.count}}+2; location.href='{% url "event_period_add" event.id %}#OP'+n">
      <i class="fa fa-area-chart"></i> OP Next
    </button>
  </nav>

</main> {# /.container #}
{% endblock %}

