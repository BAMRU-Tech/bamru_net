{% extends 'base_ftable.html' %}

{% block title %}Team Certifications{% endblock title %}


{% block subheader %}
<strong id="subhdr">Members</strong>
{% endblock subheader %}


{% block table_options %}
order: [[ 0, 'asc' ]],
columnDefs: [
    { responsivePriority: 1, targets: 0 },
    { responsivePriority: 4, targets: 1},
    { responsivePriority: 2, targets: 2 },
    { responsivePriority: 3, targets: 3},
],
language: {
      emptyTable: 'No members selected'
},
{% endblock table_options %}

{% block table_functions %}

const apiUrlMemberRank = '/api/member_certs/?member_rank=';

function AddRows(table, values) {
    //
    // Add rows based on rank =values[0]
    //
    var url = apiUrlMemberRank+values[0];
    //FIXME: add error handling
    $.getJSON(url, null, function( json ) {
        
        for (var i=0; i<json.length; i++)
        {
            var rowData = json[i];
            var data = [
                '<a href="/member/'+rowData['id']+'?returnx=cl">'+rowData['full_name']+'</a>',
                {'display': rowData['rank'], '@data-sort': rowData['rank_order']},
            ]
            var certs = rowData['certs'];
            for (var j=0; j<certs.length; j++)
            {
                data.push((certs[j] && certs[j].length) ? certs[j][0]['description'] : '');
            }

            var row = table.row.add(data).node();
            for (var j=0; j<certs.length; j++)
            {
                if (certs[j].length)
                    ($('td:eq('+ (j+2) +')', row).css('background-color', certs[j][0]['color']));
            }
            //; // invalidate needed to force rank and role display
        }
        
        // not sure why this is required here but it is needed (tried to hoist it without success)
        table.draw().columns.adjust().responsive.recalc();
    });
}

function RemoveRows(table, values) {
    // Remove rows based on rank
    table.rows(
        function ( idx, data, node ) {
            return data[1]['display'] == values[0];
        } )
        .remove();

    table.draw();
}

function UpdateSubheaderBasedOnSettings(table) {
    // Extract currently selected ranks based on filter
    var showRanks = [];
    $('#filter-rank option').each(function() {
        if (!this.selected) {
            showRanks.push(this.value);
        }
    });

    $('#subhdr')[0].innerHTML = '<a href=' + {% url 'member_list' %} + '>Members</a> (' +  showRanks.join(', ') + ') > Certifications';

}

$('#filter-rank').multiSelect({
    // The sense of the multiSelect is inverted: show = deselect, hide = select
    // *FIXME: the list of selected items should be computed from the data
    selectableHeader: '<div class="custom-header">Show</div>',
    selectionHeader: '<div class="custom-header">Hide</div>',
    afterSelect: function(values){
        RemoveRows(table,values);
        UpdateSubheaderBasedOnSettings(table);
    },
    afterDeselect: function(values){
        AddRows(table,values);
        UpdateSubheaderBasedOnSettings(table);
    }
})
{% endblock table_functions %}

{% block content %}
<main>
  <div id="show-filter" style="display: none">
    <select id="filter-rank" multiple="multiple" selectableHeader="Display rank">
      <option value='TM'>Technical Member</option>
      <option value='FM'>Field Member</option>
      <option value='T'>Trainee</option>
      <option value='R'>Reserve</option>
      <option value='S'>Support</option>
      <option value='A'>Associate</option>
      <option value='G' selected >Guest</option>
      <option value='MA' selected >Member Alum</option>
    </select>
  </div>
  <table id="dTbl" class="display table-bordered wrap" style="width:100%">
    <thead>
      <tr>
        <th>Name</th><th>Rank</th>
        {% for h in headers %}<th>{{h}}</th>{% endfor %}
      </tr>
    </thead>

    <tbody>
      {% for member in member_list %}
      <tr>
        <td><a href="{% url 'member_detail' member.id %}?returnx=cl">{{ member.full_name }}</a></td>
        <td data-sort="{{ member.rank_order }}"> {{ member.rank }}</td>
        {% for c in member.certs %}
        <td bgcolor="{{c.cert.color | default:"white" }}">
          {% if c.count %}
          {{ c.cert }}
          {% if c.count > 1 %}*{% endif %}
          {% endif %}
        </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</main>
{% endblock content %}
