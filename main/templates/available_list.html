{% extends 'base_ftable.html' %}

{# --- Page definition --- #}

{% block title %}Team Availability{% endblock title %}

{% block subheader %}
<strong id="subhdr">Members</strong>
{% endblock subheader %}

{% block content %}
<main role="main">
  <div id="show-filter" style="display: none">
    <select id="filter-rank" multiple="multiple" selectableHeader="Display rank">
      <option value='TM'>Technical Member</option>
      <option value='FM'>Field Member</option>
      <option value='T'>Trainee</option>
      <option value='R'>Reserve</option>
      <option value='S'>Support</option>
      <option value='A'>Associate</option>
      <option value='G'>Guest</option>
      <option value='MA'>Member Alum</option>
    </select>
  </div>
  <div id="tooltip"></div>
  <table id="dTbl" class="display table-bordered compact" style="width:100%">
    <thead>
      <tr>
        <th>Name</th><th>Rank</th><th>Rank order</th>
        {% for h in headers %}
        <th>
          <div class="d-none d-lg-block">{{h}}</div>
          <div class="d-none d-md-block d-lg-none">{{h|date:"M d"}}</div>
          <div class="d-block d-md-none">{{h|date:"m d"}}</div>
        </th>
        {% endfor %}
        <th>Return</th>
      </tr>
    </thead>
    
    <tbody>
      {% for member in member_list %}
      {% if member.isActive %}
      <tr>
        <td>
          <a href="{% url 'member_detail' member.id %}?returnx=al">{{ member.full_name }}</a>
        </td>
        <td>{{ member.rank }}</td>
        <td>{{ member.rank_order }}</td>
        {% for day in member.days %}
        {% if day %}
        <td style="background-color:orange" title="{{day}}" style="overflow: hidden">
          <div class="d-none d-lg-block">{{day}}</div>
          <div class="d-none d-md-block d-lg-none">{{day|truncatechars:10}}</div>
          <div class="d-none d-sm-block d-md-none">{{day|truncatechars:5}}</div>
          <div class="d-block d-sm-none">*</div>
        </td>
        {% else %}
        <td></td>
        {% endif %}
        {% endfor %}
        <td{% if member.end_date %} style="background-color:orange"{% endif %}>
          <div class="d-none d-md-block">{{member.end_date|date:"m/d/y"}}</div>
          <div class="d-block d-md-none">{{member.end_date|date:"m-d"}}</div>
        </td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
</main>
{% endblock content %}


{# --- Table definition --- #}

{% block table_options %}
order: [[ 1, 'desc' ]],

columnDefs: [
    { responsivePriority: 1, targets: 0 },
    { responsivePriority: 2, targets: [ 3, 4, 5, 6, 7, 8] },
    { responsivePriority: 10, targets: 1},
    {
        render: function ( data, type, row, meta ) {
            if (type == 'display') {
                // Add color to the busy periods
                var row = $('#dTbl').DataTable().row(meta.row).node();
                if (data && data[0] != '<')
                    $('td:eq(' + (meta.col - 1) + ')', row).css('background-color', 'orange');
            }
            return data;
        },
        targets: [ 3, 4, 5, 6, 7, 8 ],

    },
    {
        render: function(data, type, row, meta) {
            if (type == 'sort') {
                // order: asc and role_order doesn't work
                return 99 - row[2]; //FX?
            } else
                return data;
        }, targets: 1,
    },
      
    { visible: false, targets: 2 },
],

language: { emptyTable: 'No members selected' },

{% endblock table_options %}

{% block initComplete %}
{
    //FX: SLightly different
    //find members and set selection
    window.ranks = [];
    table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
        ranks[this.data()[1]] = true; //FX
    });
    ranks = Object.keys(ranks);
    $('#filter-rank > option').each( function ( i ) {
        if (ranks.includes(this.value))
            this.removeAttribute('selected');
        else
            this.setAttribute('selected', '');
    });

    $('#filter-rank').multiSelect({
        // The sense of the multiSelect is inverted: show = deselect, hide = select
        selectableHeader: '<div class="custom-header">Show</div>',
        selectionHeader: '<div class="custom-header">Hide</div>',
        afterSelect: function(values){
            RemoveRows(table,values);
            UpdateSubheaderBasedOnSettings(table);
        },
        afterDeselect: function(values){
            AddRows(table,values);
            UpdateSubheaderBasedOnSettings(table);
        }
    })
}
{% endblock initComplete %}

{% block functions %}

// Seems a little crazy that js doesn't offer better date support
// But not worth loading another 20-30K
function DateArray(start_date, days) {
    //
    // Create date array for date range, ISO formatted
    //
    const m = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const mn = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];

    var result = [];
    for (var i = 0; i < days; i++) {
        var date = new Date(start_date);
        date.setDate(date.getDate() + i);
        var ds = date.toDateString().replace(/.{3} (.{3}) (\d{2}) (\d{4})/, '$3-$1-$2');
        var month = ds.substr(5, 3);
        ds = ds.replace(month, mn[m.indexOf(month)]);
        result.push(ds);
    }
    return result;
}

var numDays = 5;

function SetBusy(busy, start, end, comment) {
    //FIXME: make 'comment' a modal popup or tool tip or both
    if (start < 0) start = 0;
    if (end <= 0) end = numDays;
    for (var i = start; i < end; i++) busy[i] = comment;
    return i;
}

const apiUrlMemberRank = '/api/member_availability/?member_rank=';

function AddRows(table, values) {
    //
    // Add rows based on rank =values[0]
    //
    var url = apiUrlMemberRank+values[0];

    var dd = DateArray(Date(), 5);
    url += '&date_range_start='+dd[0]+'&date_range_end='+dd[4];
    //FIXME: add error handling
    $.getJSON(url, null, function( json ) {
        var dd = DateArray(Date(), 5);
        
        // Foreach member mark busy period within date range
        for (var m = 0; m < json.length; m++)
        {
            var row = json[m];
            var data = [
                '<a href="/member/' + row.id+'?returnx=al">' + row.full_name + '</a>',
                row.rank, row.rank_order
            ];
            var busy = Array(numDays + 1).fill('');
            var period = row.busy;
            for (var p = 0; p < period.length; p++) {
                var start_on = dd.indexOf(period[p].start_on);
                var end_on = dd.indexOf(period[p].end_on) + 1;
                var comment = period[p].comment;
                if (comment) {
                    //FIXME: It would be nice to use different display sizes
                    //Decide on appropriate constants
                    if (comment.length > 10) comment = comment.slice(0, 10);
                } else
                    // API doesn't match member_view code
                    comment = 'BUSY';
                SetBusy(busy, start_on, end_on, comment);
                if (end_on <= 0)
                    busy[numDays] = period[p].end_on;
            }

            data = data.concat(busy);

            table.row.add(data);
        }

        // redraw table after async call
        table.draw().columns.adjust().responsive.recalc();
    })
}

function RemoveRows(table, values) {
    // Remove rows based on rank
    table.rows(
        function ( idx, data, node ) {
            return data[1] == values[0];
        } )
        .remove();

    table.draw();
}

function UpdateSubheaderBasedOnSettings(table) {
    // Extract currently selected ranks based on filter
    var showRanks = [];
    $('#filter-rank option').each(function() {
        if (!this.selected) {
            showRanks.push(this.value);
        }
    })

    $('#subhdr')[0].innerHTML = '<a href=' + {% url 'member_list' %} + '>Members</a> (' +  showRanks.join(', ') + ') > Availability';
}

{% endblock functions %}
