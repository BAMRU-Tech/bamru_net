{% extends 'base_ftable.html' %}

{% block title %}Certs - {{member.full_name}} {% endblock title %}

{% block subheader %}
<strong id="subhdr">>
  <a href="{% url 'member_detail' member.id %}?returnx=mc">{{member.full_name }} ({{ member.rank }})</a>
    &gt; Certs
</strong>
{% endblock subheader %}


{% block table_options %}
dom: 'Bfrtip',
responsive: true,
select: 'os',
altEditor: true,
order: [[ 4, 'desc']],
columnDefs: [ // FIXME: sort by most expired cert?
    {
        targets: [ 1, 4 ],
        'render': function ( data, type, rowData, meta ) {
            if (meta['col'] == 0 && rowData['display']) {
                // Handle type 'cpr' -> 'CPR'
                data = rowData['display']
            } else {
                // Add color for up coming cert expirations
                var row = $('#dTbl').DataTable().row(meta['row']).node();
                $('td:eq(4)', row).css('background-color', rowData['color'])
            }
            return data;
        },
    },
    { responsivePriority: 0, targets: 1 },
    { responsivePriority: 2, targets: 2 },
    { responsivePriority: 3, targets: 3 },
    { responsivePriority: 1, targets: 4 },
],
columns: [
    { data: 'mark',
      orderable: false,
      className: 'mark-checkbox',
      type: ['readonly', 'hidden'],
      render: function(data, type, row) {
          return '<div data-id="'+row.id+'"></div>';
      },
    },
    { data: 'type', type: 'readonly' },
    { data: 'description' },
    { data: 'url' },
    { data: 'expiration' },
    { data: 'id', type: ['read-only', 'hidden'], visible: false },
    { data: 'is_expired', type: ['read-only', 'hidden'], visible: false },
    { data: 'color', type: ['read-only', 'hidden'], visible: false },
],
language: {
    emptyTable: 'No busy periods'
},

onAddRow: function(dt, row, success, error) {

    var data = row;

    data['member'] = $('#memberId').val();
    data = JSON.stringify(data);
    //FIXME: error handling
    $.ajax({
        method: 'POST',
        contentType: 'application/json',
        url: '/api/availability/',
        data: data,
        success: function (r, s, m) {
            return success(r, s, m);
        },
        error: function (xhr) {
            console.log('availability add failed');
            console.log(xhr);
            alert(xhr.responseText);
            return false;
        }
    })
},

onEditRow: function(dt, row, success, error) {

    var data = row;

    delete data['type'];

    var id = data['id'];
    data = JSON.stringify(data);
    //FIXME: error handling
    $.ajax({
        method: 'PATCH',
        contentType: 'application/json',
        url: '/api/certs/' + id + '/',
        data: data,
        success: function (r, s, m) {
            return success(r, s, m);
        },
        error: function (xhr) {
            console.log('cert edit failed');
            console.log(xhr);
            alert(xhr.responseText);
            return false;
        }
    })
},

{% endblock table_options %}

{% block table_buttons_first %}
{
    text: '<i class="fa fa-certificate"></i> Add',
    extend: 'collection',
    autoClose: true,
    buttons: [
        {% for type in cert_types %}
        {
            text: 'Add {{ type.1 }}',
            action: function () {
                location.href ='{% url "member_cert_new" member.id %}?type={{type.0}}&returnx=mc';
            }

        },
        {% endfor %}
    ]
},
{
    extend: 'selected', // Bind to Selected row
    text: '<i class="fa fa-edit"></i> Edit',
    name: 'edit'        // do not change name
},
{
    extend: 'selected', // Bind to Selected row
    autoClose: true,
    text: '<i class="fa fa-trash"></i> Delete',
    action: DeleteCerts,
},

{% endblock table_buttons_first %}

{# remove filter button #}
{% block table_buttons_filter %}{% endblock %}

{% block table_functions %}

function DeleteCerts ( e, dt, node, config ) {
    var certs = [];
    $.each($('td.mark-checkbox.marked'), function (i, el) {
        certs.push($(this.firstChild).data().id)
    });
    console.log(certs);

    if (certs.length == 0) {
        alert('Select certs before deleting them');
        return;
    }

    var ok = confirm('Delete '+certs.length+' certs?');

    if (ok) {
        for (var i=0; i<certs.length; i++) {
            //FIXME: error handling
            $.ajax({
                method: 'DELETE',
                contentType: 'application/json',
                url: '/api/certs/' + certs[i] + '/',
                error: function (msg) {
                    console.log('availability delete failed: '+msg);
                    alert(msg);
                    return false;
                },
            })
        }
        //FIXME: This seems like a bad idea but there is delay getting the updated data
        setTimeout(function(){
            location.reload(true);
        }, 200);
    }
}

function MarkRow ( e, dt, type, indices ) {
        var allMarked = true;
        var numRows = indices.length;
        if (numRows > 1) {
            dt.rows(indices).every( function ( rowIdx, tableLoop, rowLoop ) {
                // For multi select - unmark only when every row is marked
                allMarked = allMarked && $(this.nodes()).children().first().hasClass('marked');
            })
        }
        dt.rows(indices)
            .every( function ( rowIdx, tableLoop, rowLoop ) {
                if (numRows > 1) {
                    if (allMarked)
                        $(this.node()).children().first().removeClass('marked');
                    else
                        $(this.node()).children().first().addClass('marked');
                } else {
                    if ($(this.node()).children().first().hasClass('marked')) {
                        $(this.node()).children().first().removeClass('marked');
                        this.deselect();
                    } else
                        $(this.node()).children().first().addClass('marked');
                }
            });
}

function UpdateSubheaderBasedOnSettings(table) {}

{% endblock table_functions %}

{% block ready_functions %}
    table.on( 'select', MarkRow);
{% endblock ready_functions %}


{% block content %}
<main>
  <table id="dTbl" class="display table-bordered wrap" style="width:100%">
    <thead>
      <tr>
        <th></th>
        <th>Type</th>
        <th>Description</th>
        <th>Documentation</th>
        <th>Expiration</th>
        <th>Id</th>
        <th>Expired</th>
        <th>Highlight</th>
    </thead>

    <tbody>
      {% for cert in cert_list %}
      <tr>
        <td></td>
        <td>{{ cert.get_type_display }}</td>
        <td>{{ cert.description }}</td>
        <td>
          {% if cert.link %}
            <a href="{{ cert.link }}">{{cert.link}}</a>
          {% endif %}
        </td>
        <td>{{ cert.expiration|date:"Y-m-d" }}</td>
        <td>{{ cert.id }}</td>
        <td>{{ cert.is_expired }}</td>
        <td>{{ cert.color }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</main>
{% endblock content %}
