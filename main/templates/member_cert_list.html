{% extends 'base_ftable.html' %}

{# --- Page definition --- #}

{% block title %}Certs - {{member.full_name}} {% endblock title %}

{% block subheader %}
<strong id="subhdr">
    <a href="{% url 'member_detail' member.id %}?returnx=mc">
    {{member.full_name }} ({{ member.rank }})</a>
    &gt; Certs
</strong>
{% endblock subheader %}

{% block content %}
<main role="main">
  <table id="dTbl" class="display table-bordered wrap" style="width:100%">
    <tbody>
      {% for cert in cert_list %}
      <tr>
        <td></td>
        <td>{{ cert.get_type_display }}</td>
        <td>{{ cert.description }}</td>
        <td>
          {% if cert.link %}
            <a href="{{ cert.link }}">{{cert.link}}</a>
          {% endif %}
        </td>
        <td>{{ cert.comment }}</td>
        <td>{{ cert.expiration|date:"Y-m-d" }}</td>
        <td>{{ cert.id }}</td>
        <td>{{ cert.is_expired }}</td>
        <td>{{ cert.color }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</main>
{% endblock content %}


{# --- Table definition --- #}

{% block table_options %}
select: 'os',
altEditor: true,

order: [[ 5, 'desc']],

columnDefs: [ //FIXME: sort by most expired cert?
    {
        targets: [ 1, 4 ],
        render: function ( data, type, row, meta ) {
            if (meta.col == 0 && row.display) {
                // Handle type 'cpr' -> 'CPR'
                data = row.display
            } else {
                // Add color for up coming cert expirations
                var rnode = $('#dTbl').DataTable().row(meta.row).node();
                $('td:eq(4)', rnode).css('background-color', row.color)
            }
            return data;
        },
    },
],

//*FIXME: Should the comment col be displayed?
columns: [
    { data: 'mark', width: '10px', responsivePriority: 1,
      orderable: false,
      className: 'mark-checkbox',
      type: ['readonly', 'hidden'],
      render: function(data, type, row, meta) {
          return '<div data-id="' + row.id + '"></div>';
      },
    },
    { data: 'type', type: 'readonly', title: 'Type', responsivePriority: 1, },
    { data: 'description', title: 'Description', responsivePriority: 3, },
    { data: 'link', title: 'Documentation', responsivePriority: 4,
      render: function(data, type, row, meta) {
          if (type == 'display' && data == '') 
              return row.comment;
          else
              return data
      }
    },
    { data: 'comment', title: 'Comment', visible: false, },
    { data: 'expiration', title: 'Expiration', responsivePriority: 2,
      type: 'date', 
      render: function(data, type, row, meta) {
          if (type == 'display' && data != '') {
                  var date = new Date(data+'T00:00');
                  return date.toLocaleDateString();
          } else
              return data;
      },
    },
    { data: 'id', type: ['read-only', 'hidden'], visible: false, title: 'Id', },
    { data: 'is_expired', type: ['read-only', 'hidden'], visible: false, title: 'Expired', },
    { data: 'color', type: ['read-only', 'hidden'], visible: false, title: 'HiLite', },
],

language: { emptyTable: 'No busy periods' },

onAddRow: AddCert,
onEditRow: UpdateRow,

{% endblock table_options %}

{% block table_buttons_first %}
{
    text: '<i class="fa fa-certificate"></i> Add',
    extend: 'collection',
    autoClose: true,
    buttons: [
        {% for type in cert_types %}
        {
            text: 'Add {{ type.1 }}',
            action: function () {
                location.href ='{% url "member_cert_new" member.id %}?type={{type.0}}&returnx=mc';
            }

        },
        {% endfor %}
    ]
},
{
    extend: 'selected', // Bind to Selected row
    text: '<i class="fa fa-edit"></i> Edit',
    name: 'edit'        // do not change name
},
{
    autoClose: true,
    text: '<i class="fa fa-trash"></i> Delete',
    action: DeleteCerts,
},

{% endblock table_buttons_first %}

{# remove filter button #}
{% block filter_button %}{% endblock %}

{% block table_functions %}

//FIXME: Currently using cert_form
function AddCert (dt, row, success, error) {
    var data = row;

    data.member = $('#memberId').val();
    data = JSON.stringify(data);
    //FIXME: error handling
    $.ajax({
        method: 'POST',
        contentType: 'application/json',
        url: '/api/availability/',
        data: data,
        success: function (r, s, m) {
            return success(r, s, m);
        },
        error: function (xhr) {
            console.log('availability add failed');
            console.log(xhr);
            alert(xhr.responseText);
            return false;
        }
    })
}

function UpdateRow (dt, row, success, error) {
    var data = row;

    delete data.type;

    var id = data.id;
    data = JSON.stringify(data);
    //FIXME: error handling
    $.ajax({
        method: 'PATCH',
        contentType: 'application/json',
        url: '/api/certs/' + id + '/',
        data: data,
        success: function (r, s, m) {
            // Clear marks
            $('td.marked').removeClass('marked');
            return success(r, s, m);
        },
        error: function (xhr) {
            console.log('cert edit failed');
            console.log(xhr);
            alert(xhr.responseText);
            return false;
        }
    })
}

function DeleteCerts ( e, dt, node, config ) {
    var certs = [];
    $.each($('td.mark-checkbox.marked'), function (i, el) {
        certs.push($(this.firstChild).data().id)
    });
    console.log(certs);

    if (certs.length == 0) {
        alert('Select certs before deleting them');
        return;
    }

    var ok = confirm('Delete '+certs.length+' certs?');

    if (ok) {
        for (var i=0; i<certs.length; i++) {
            //FIXME: error handling
            $.ajax({
                method: 'DELETE',
                contentType: 'application/json',
                url: '/api/certs/' + certs[i] + '/',
                success: function () {
                    location.reload(true);
                },
                error: function (msg) {
                    console.log('cert delete failed: '+msg);
                    alert(msg);
                    return false;
                },
            })
        }
    }
}

function MarkRow ( e, dt, type, indices ) {
    var allMarked = true;
    var numRows = indices.length;
    if (numRows > 1) {
        dt.rows(indices).every( function ( rowIdx, tableLoop, rowLoop ) {
            // For multi select - unmark only when every row is marked
            allMarked = allMarked && $(this.nodes()).children().first().hasClass('marked');
        })
    }
    dt.rows(indices)
        .every( function ( rowIdx, tableLoop, rowLoop ) {
            if (numRows > 1) {
                if (allMarked)
                    $(this.node()).children().first().removeClass('marked');
                else
                    $(this.node()).children().first().addClass('marked');
            } else {
                if ($(this.node()).children().first().hasClass('marked')) {
                    $(this.node()).children().first().removeClass('marked');
                    this.deselect();
                } else
                    $(this.node()).children().first().addClass('marked');
            }
        });
}

function UpdateSubheaderBasedOnSettings(table) {}

{% endblock table_functions %}

{% block ready_functions %}
    table.on( 'select', MarkRow);
{% endblock ready_functions %}
