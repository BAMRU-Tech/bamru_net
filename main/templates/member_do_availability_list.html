{% extends 'base_ftable.html' %}

{# --- Page definition --- #}

{% block title %}Availability{% endblock title %}

{% block subheader %}
<strong>
  <a href="{% url 'member_detail' member.id %}?returnx=ma">
    {{member.full_name }} ({{ member.rank }})
  </a>
  &gt; DO Availability
</strong>
{% endblock subheader %}

{% block content %}
<h4>Work in progress</h4>
<main>
  <table id="dTbl" class="display table-bordered nowrap" style="width:100%"></table>
</main>
{% endblock content %}


{# --- Table definition --- #}

{% block table_options %}

select: 'os',
altEditor: true,

order: [[ 1, 'asc']],

columns: [
    { data: 'mark',
      orderable: false,
      className: 'mark-checkbox',
      type: ['readonly', 'hidden'],
      render: function(data, type, row) {
          return '<div data-id="'+row.id+'"></div>';
      },
    },
    { data: 'week', type: 'number', title: 'Week' },
    { data: 'available', title: 'Available', responsivePriority: 0 },
    { data: 'comment', title: 'Comment' },
    { data: 'id', title: 'ID',
      visible: false,
      type: ['readonly', 'hidden']
    },
],

language: { emptyTable: 'No DO periods' },

onEditRow: EditRow,

{% endblock table_options %}

{% block table_buttons_first %}
{
    extend: 'selected', // Bind to Selected row
    text: '<i class="fa fa-edit"></i> Edit',
    name: 'edit'        // do not change name
},

{% endblock table_buttons_first %}

{# remove filter button #}
{% block filter_button %}{% endblock %}


{% block table_functions %}
function InitialData() {
    //
    // Add rows based on date range
    //
    const apiUrlDoAvailEvent = '/api/do/?member={{ request.user.id }}&year=2018&quarter=3';
    var url = apiUrlDoAvailEvent;
    
    table.clear();

    const titleLength = 40;
    //FIXME: add error handling
    $.getJSON(url, null, function( json ) {
        
        for (var i=0; i<json.length; i++)
        {
            var data = json[i];
//            var title = data['title'];
  //          if (title.length > titleLength) 
    //            title = title.substring(0, titleLength - 3) + '...';
            //      data['href_title'] = '<a href="/event/' + data['id'] + '/">' + title + '</a>';
            data['comment'] = (data['comment']) ? data['comment'] : '';  //FIXME: comment isn't returned
            table.row.add(data).invalidate()
        }
        table.draw().columns.adjust().responsive.recalc();
    })

}


function MarkRow ( e, dt, type, indices ) {
        var allMarked = true;
        var numRows = indices.length;
        if (numRows > 1) {
            dt.rows(indices).every( function ( rowIdx, tableLoop, rowLoop ) {
                // For multi select - unmark only when every row is marked
                allMarked = allMarked && $(this.nodes()).children().first().hasClass('marked');
            })
        }
        dt.rows(indices)
            .every( function ( rowIdx, tableLoop, rowLoop ) {
                if (numRows > 1) {
                    if (allMarked)
                        $(this.node()).children().first().removeClass('marked');
                    else
                        $(this.node()).children().first().addClass('marked');
                } else {
                    if ($(this.node()).children().first().hasClass('marked')) {
                        $(this.node()).children().first().removeClass('marked');
                        this.deselect();
                    } else
                        $(this.node()).children().first().addClass('marked');
                }
            });
}


function EditRow (dt, row, success, error) {

    var data = row;

    var id = data['id']; //XX
    data = JSON.stringify(data);
    //FIXME: error handling
    $.ajax({
        method: 'PATCH',
        contentType: 'application/json',
        url: '/api/availability/' + id + '/',
        data: data,
        success: function (r, s, m) {
            var name = r['member']['full_name'];
            return success(r, s, m);
        },
        error: function (xhr) {
            console.log('availability edit failed');
            console.log(xhr);
            alert(xhr.responseText);
            return false;
        }
    })
}


function UpdateSubheaderBasedOnSettings(table) {}

{% endblock table_functions %}


{% block ready_functions %}
table.on( 'select', MarkRow);
InitialData();
{% endblock ready_functions %}


