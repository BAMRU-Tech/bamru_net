{% extends 'base_ftable.html' %}

{# --- Page definition --- #}

{% block title %}Availability{% endblock title %}

{% block subheader %}
<strong>
  <a href="{% url 'member_detail' member.id %}?returnx=ma">
    {{member.full_name }} ({{ member.status }})
  </a>
  &gt; DO Availability<span id="subhdr"></span>
</strong>
{% endblock subheader %}

{% block content %}
<main role="main">
  <table id="dTbl" class="display table-bordered compact" style="width:100%">
  </table>
</main>
{% endblock content %}


{# --- Table definition --- #}

{% block table_options %}

select: 'os',
altEditor: true,

order: [[ 0, 'asc']],

columns: [
    { data: 'week', title: 'Week', width: '10%',
      type: ['readonly'], className: 'dt-center',
    },
    { data: 'available', title: 'Available', width: '10%', responsivePriority: 1,
      type: 'select', options: [false, true], className: 'dt-center',
    },
    { data: 'comment', title: 'Comment' },
    { data: 'id',
      visible: false,
      type: ['readonly', 'hidden']
    },
    { data: 'assigned', width: '10%', responsivePriority: 1,
      visible: false,
      type: ['readonly', 'hidden']
    },
],

language: { emptyTable: 'No DO periods' },

onEditRow: UpdateRow,

{% endblock table_options %}

{% block table_buttons_first %}

{
    extend: 'selected', // Bind to Selected row
    text: '<i class="fa fa-edit"></i> Edit',
    name: 'edit'        // do not change name
},
{
    text: '<i class="fa fa-plus-square-o"></i> Set all',
    action: SetAll,
},
{
    text: '<i class="fa fa-minus-square-o"></i> Clear all',
    action: ClearAll,
},
{
    text: '<i class="fa fa-caret-square-o-left"></i> Prev',
    action: PrevQtr
},
{
    text: '<i class="fa fa-caret-square-o-right"></i> Next',
    action: NextQtr
},

{% endblock table_buttons_first %}

{# remove filter button #}
{% block filter_button %}{% endblock %}


{% block functions %}

function SetAll ( e, dt, node, config ) {
    dt.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
        var data = this.data();
        data.available = true;
        this.data(data);
        UpdateRow(table, data);
    } )
}

function ClearAll ( e, dt, node, config ) {
    dt.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
        var data = this.data();
        data.available = false;
        this.data(data);
        UpdateRow(table, data);
    } )
}

var currentPeriod = GetPeriod();

function PrevQtr ( e, dt, node, config ) {
    currentPeriod.quarter -= 1;
    if (currentPeriod.quarter < 1) {
        currentPeriod.quarter = 4;
        currentPeriod.year -= 1;
    }

    InitialData()
    UpdateSubheaderBasedOnSettings(dt)
}

function NextQtr ( e, dt, node, config ) {
    currentPeriod.quarter += 1;
    if (currentPeriod.quarter > 4) {
        currentPeriod.quarter = 1;
        currentPeriod.year += 1;
    }

    InitialData()
    UpdateSubheaderBasedOnSettings(dt)
}

function GetPeriod(d) {
    d = d || new Date(); // If no date supplied, use today
    return { quarter: Math.floor((d.getMonth() + 3) / 3),
             year: d.getFullYear() };
}

function InitialData() {
    // Add rows based on date range
    const apiUrlDoAvailEvent =
          '/api/do/?member={{ request.user.id }}' +
          '&year=' + currentPeriod.year + '&quarter=' + currentPeriod.quarter;
    var url = apiUrlDoAvailEvent;
    
    table.clear();

    $.getJSON(url, null, function( json ) {
        
        for (var i=0; i<json.length; i++)
        {
            var data = json[i];
            table.row.add(data);
        }
        table.draw().columns.adjust().responsive.recalc();
    })
}

function UpdateRow (dt, row,
                    success = function() { return true },
                    error = function() { return false })
{

    var data = row;

    var id = data.id;
    data = JSON.stringify(data);
    $.ajax({
        method: 'PATCH',
        contentType: 'application/json',
        url: '/api/do/' + id + '/',
        data: data,
        success: success,
        error: function (xhr) {
            console.log('availability edit failed');
            console.log(xhr);
            alert(xhr.responseText);
            return false;
        }
    })
}


function UpdateSubheaderBasedOnSettings(table) {
    $('#subhdr')[0].innerHTML = ' Q' + currentPeriod.quarter + ' - ' +
        currentPeriod.year;
}

{% endblock functions %}


{% block ready_functions %}
InitialData();
{% endblock ready_functions %}


