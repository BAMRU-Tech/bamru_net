{% extends 'base_ftable.html' %}

{% block title %}Member Availability{% endblock title %}

{% block subheader %}
<strong>
  <a href="{% url 'member_detail' member.id %}?returnx=ma">{{member.full_name }} ({{ member.rank }})</a>
  &gt; Availability
</strong>
{% endblock subheader %}


{% block table_options %}
dom: 'Bfrtip',
responsive: true,
select: 'os',
altEditor: true,
order: [[ 1, 'desc']],
columnDefs: [],
columns: [
    { data: 'mark',
      orderable: false,
      className: 'mark-checkbox',
      type: ['readonly', 'hidden'],
      render: function(data, type, row) {
          return '<div data-id="'+row.id+'"></div>';
      },
    },
    { data: 'start_on' },
    { data: 'end_on' },
    { data: 'comment' },
    { data: 'id',
      visible: false,
      type: ['readonly', 'hidden']
    },
],
language: {
    emptyTable: 'No busy periods'
},

onAddRow: function(dt, row, success, error) {

    var data = row;

    data['member'] = $('#memberId').val();
    data = JSON.stringify(data);
    //FIXME: error handling
    $.ajax({
        method: 'POST',
        contentType: 'application/json',
        url: '/api/availability/',
        data: data,
        success: function (r, s, m) {
            r['mark'] = '';
            success(r, s, m);
        },
        error: function (xhr) {
            console.log('availability add failed');
            console.log(xhr);
            alert(xhr.responseText);
            return false;
        }
    })
},

onEditRow: function(dt, row, success, error) {

    var data = row;

    var id = data['id'];
    data = JSON.stringify(data);
    //FIXME: error handling
    $.ajax({
        method: 'PATCH',
        contentType: 'application/json',
        url: '/api/availability/' + id + '/',
        data: data,
        success: function (r, s, m) {
            var name = r['member']['full_name'];
            return success(r, s, m);
        },
        error: function (xhr) {
            console.log('availability edit failed');
            console.log(xhr);
            alert(xhr.responseText);
            return false;
        }
    })
},

{% endblock table_options %}

{% block table_buttons_first %}
{
    text: '<i class="fa fa-calendar-times-o"></i> Add',
    name: 'add'        // do not change name
},
{
    extend: 'selected', // Bind to Selected row
    text: '<i class="fa fa-edit"></i> Edit',
    name: 'edit'        // do not change name
},
{
    extend: "selected", // Bind to Selected row
    autoClose: true,
    text: '<i class="fa fa-trash"></i> Delete',
    action: DeleteBusyPeriods,
},

{% endblock table_buttons_first %}

{# remove filter button #}
{% block table_buttons_filter %}{% endblock %}

{% block table_functions %}

function DeleteBusyPeriods ( e, dt, node, config ) {
    var periods = [];
    $.each($('td.mark-checkbox.marked'), function (i, el) {
        periods.push($(this.firstChild).data().id)
    });
    console.log(periods);

    if (periods.length == 0) {
        alert('Select periods before deleting them');
        return;
    }

    var ok = confirm('Delete '+periods.length+' periods?');

    if (ok) {
        for (var i=0; i<periods.length; i++) {
            //FIXME: error handling
            $.ajax({
                method: 'DELETE',
                contentType: 'application/json',
                url: '/api/availability/' + periods[i] + '/',
                error: function (msg) {
                    console.log('availability delete failed: '+msg);
                    alert(msg);
                    return false;
                },
            })
        }
        //FIXME: This seems like a bad idea but there is delay getting the updated data
        setTimeout(function(){
            location.reload(true);
        }, 200);
    }
}

function MarkRow ( e, dt, type, indices ) {
        var allMarked = true;
        var numRows = indices.length;
        if (numRows > 1) {
            dt.rows(indices).every( function ( rowIdx, tableLoop, rowLoop ) {
                // For multi select - unmark only when every row is marked
                allMarked = allMarked && $(this.nodes()).children().first().hasClass('marked');
            })
        }
        dt.rows(indices)
            .every( function ( rowIdx, tableLoop, rowLoop ) {
                if (numRows > 1) {
                    if (allMarked)
                        $(this.node()).children().first().removeClass('marked');
                    else
                        $(this.node()).children().first().addClass('marked');
                } else {
                    if ($(this.node()).children().first().hasClass('marked')) {
                        $(this.node()).children().first().removeClass('marked');
                        this.deselect();
                    } else
                        $(this.node()).children().first().addClass('marked');
                }
            });
}

function UpdateSubheaderBasedOnSettings(table) {}

{% endblock table_functions %}

{% block ready_functions %}
    table.on( 'select', MarkRow);
{% endblock ready_functions %}


{% block content %}
<main>
  <table id="dTbl" class="display table-bordered nowrap" style="width:100%">
    <thead>
      <tr>
        <th></th>
        <th>Start</th>
        <th>End</th>
        <th>Comment</th>
        <th>Id</th>
      </tr>
    </thead>

    <tbody>
      {% for busy in availability_list %}
      <tr>
        <td></td>
        <td>{{ busy.start_on|date:"Y-m-d" }}</td>
        <td>{{ busy.end_on|date:"Y-m-d" }}</td>
        <td>{{ busy.comment }}</td>
        <td>{{ busy.id }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <input type="hidden" id="memberId" value="{{ member.id }}">
</main>
{% endblock content %}
