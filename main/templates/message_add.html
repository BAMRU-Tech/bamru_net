{% extends 'base_ftable.html' %}

{# --- Page definition --- #}

{% block title %}New Compose Message{% endblock %}

{% block subheader %}
<strong id="subhdr">Event Page</strong>
{% endblock subheader %}

{% block content %}
<main role="main" class="container">
  <input type="hidden" name="author" value="{{author}}" id="id_author" />
  <div class="form-group">
    <label for="id_text">Message:</label>
    <textarea name="text" cols="40" rows="2" class="form-control"
              placeholder="Enter message for {{text}}"
              title="" required id="id_text"
              >{{text}}: {{rsvp_template.text}}</textarea>
  </div>
  <input type="hidden" name="format" value="{{format}}" id="id_format" />
  <input type="hidden" name="period" value="{{period_id}}" id="id_period" />
  <input type="hidden" name="period_format" value="{{period_format}}" id="id_period_format" />
  <input type="hidden" name="rsvp_template" value="{{rsvp_template.id}}" id="id_rsvp_template" />
  <div class="form-group">
    <div class="form-check">
      <input type="checkbox" name="email" class="form-check-input" id="id_email" checked />
      <label class="form-check-label" for="id_email">Email</label>
    </div>
  </div>
  <div class="form-group">
    <div class="form-check">
      <input type="checkbox" name="sms" class="form-check-input" id="id_sms" />
      <label class="form-check-label" for="id_sms">Sms</label>
    </div>
  </div>

  <div id="show-filter" style="display: none">
    <select id="filter-rank" multiple="multiple" selectableHeader="Display rank">
      <option value="TM">Technical Member</option>
      <option value="FM">Field Member</option>
      <option value="T">Trainee</option>
      <option value="R">Reserve</option>
      <option value="S">Support</option>
      <option value="A">Associate</option>
      <option value="G">Guest</option>
      <option value="MA">Member Alum</option>
    </select>
  </div>

  <table id="dTbl" class="display table-bordered nowrap" style="width:100%">
    <tbody>
      {% if member_list.count %}
      {% for member in member_list %}
      {% spaceless %}
      <tr>
        <td data-id={{ member.id }}></td>
        <td>
          <a href="{% url 'member_detail' member.id %}?returnx=ml">{{ member.full_name }}</a>
        </td>
        <td>{{ member.rank }}</td>
        <td>{{ member.rank_order }}</td>
        <td>{{ member.roles }}</td>
        <td>{{ member.role_order }}</td>
        <td>{{ member.display_phone }}</td>
        <td>{{ member.display_email }}</td>
      </tr>
      {% endspaceless %}
      {% endfor %}
      {% endif %}
    </tbody>
  </table>
</main>
{% endblock content%}


{# --- Table definition --- #}

{% block table_options %}
select: 'os',

order: [[ 1, 'asc' ]],

columns: [
    { data: 'mark', responsivePriority: 1,
      width: '10px',
      orderable: false,
      className: 'mark-checkbox',
    },
    //FIXME: Add render and check on use of id
    { data: 'name', title: 'Name', responsivePriority: 1, },
    { data: 'rank', title: 'Rank', responsivePriority: 5,
      render: function(data, type, row, meta) {
          if (type == 'sort')
              return row.rank_order;
          else
              return data;
      }
    },
    { data: 'rank_order', visible: false, },
    { data: 'roles', title: 'Roles', responsivePriority: 4,
      render: function(data, type, row, meta) {
           if (type == 'sort') {
               return 99 - row.role_order; //FX?
           } else
              return data;
      }
    },
    { data: 'role_order', visible: false, },
    { data: 'display_phone', title: 'Phone', responsivePriority: 2, },
    { data: 'display_email', title: 'Email', responsivePriority: 3, }
],

language: { emptyTable: 'No participants selected' },

{% endblock table_options %}

{% block table_buttons_first %}

{ text: '<i class="fa fa-address-book"></i> Send Page', action: SendPage, },
{ text: 'Select All', action: SelectAll, },
{ text: 'Clear All', action: ClearAll, },

{% endblock table_buttons_first %}

{% block initComplete %}
SetMemberFilter (table, false);
{% endblock initComplete %}

{% block ready_functions %}

table.on( 'select', function ( e, dt, type, indices ) {
    var allMarked = true;
    var numRows = indices.length;
    if (numRows > 1) {
        dt.rows(indices).every( function ( rowIdx, tableLoop, rowLoop ) {
            // For multi select - unmark only when every row is marked
            allMarked = allMarked && $(this.nodes()).children().first().hasClass('marked');
        })
    }
    dt.rows(indices).every( function ( rowIdx, tableLoop, rowLoop ) {
        if (numRows > 1) {
            if (allMarked)
                $(this.node()).children().first().removeClass('marked');
            else
                $(this.node()).children().first().addClass('marked');
        } else {
            if ($(this.node()).children().first().hasClass('marked')) {
                $(this.node()).children().first().removeClass('marked');
                this.deselect();
            } else
                $(this.node()).children().first().addClass('marked');
        }
    });
});

{% endblock ready_functions %}



{% block functions %}

{# Define constants based on input params #}
const url = new URL(window.location.href);
const eventId = url.searchParams.get('eid');
const periodPosition = url.searchParams.get('OP');
const periodId = url.searchParams.get('period');
const periodFormat = url.searchParams.get('period_format');
const page = url.searchParams.get('page');

const apiUrlMemberRank = '/api/members/?member_rank=';
var showRanks = [];

function SendPage ( e, dt, node, config ) {
    var members = [];
    $('td.mark-checkbox.marked').each(function (i, el) {
        members.push($(this).data('id'))
    });
    
    if (members.length == 0) {
        alert('Select members before paging them');
        return;
    }
    
    var viaEmail = $('input[name=email]').prop('checked') ;
    var viaSms = $('input[name=sms]').prop('checked');
    var via = '';
    
    if (viaEmail && viaSms) {
        via = '(email, sms)';
    } else if (viaEmail) {
        via = '(email)';
    } else if (viaSms) {
        via = '(sms)';
    } else {
        via = '()';
    }
    var text = $('#id_text').val();
    var ok = confirm('Page via '+via+' '+members.length+' members\nMessage: '+text);
    if (!ok) return false;
    console.log(members);
    
    var data = {};
    data.text = text;
    data.format = 'page';
    data.period = periodId;
    data.period_format = periodFormat;
    data.rsvp_template = page;
    data.distribution_set = [];
    for (var i = 0; i < members.length; i++) {
        data.distribution_set.push({
          'member': members[i],
          'email': viaEmail,
          'phone': viaSms,
        });
    }
    data = JSON.stringify(data);
    //FIXME: add error handling
    $.ajax({
        method: 'POST',
        contentType: 'application/json',
        url: '/api/message/',
        data: data,
        success: function (response) {
            console.log(response);
            var message_id = response.id;
            location.href='/message/' + message_id + '/';
        },
        error: function (xhr) {
            console.log('Message add failed');
            console.log(xhr);
            alert(xhr.responseText);
            return false;
        }
    })
}

function SelectAll ( e, dt, node, config ) {
    $('td.mark-checkbox').addClass('marked');
}

function ClearAll ( e, dt, node, config ) {
    $('td.mark-checkbox').removeClass('marked');
    table.rows().deselect();
}

function UpdateSubheaderBasedOnSettings (table) {
    // Extract currently selected ranks based on filter
    showRanks = [];
    $('#filter-rank option').each(function() {
        if (!this.selected) {
            showRanks.push(this.value);
        }
    });

    $('#subhdr')[0].innerHTML =
        ('<a href="/event/' + eventId + '/#OP' + periodPosition + '">' +
         '{{ text }}</a>:'+ page +' > Page Participants (' +
         showRanks.join(', ') + ')');
    document.title = '{{ text }} Page';
    table.draw();

}

$.fn.dataTable.ext.search.push(
    function( settings, data, dataIndex ) {
        var node = $('#dTbl').DataTable().row(dataIndex).node();
        if ( showRanks.includes(data[2]) ) {
            if (periodFormat != 'invite') //*FIXME: this really isn't the right place
                $(node).children().first().addClass('marked');
            return true;
        }

        // Clear the selection
        $(node).children().first().removeClass('marked');
        return false;
    }
);

$('#id_text').after($("<div id='length-message' class='text-muted'>"));
$('#id_text').on('input', function(){
    var length = $('#id_text').val().length;
    //FIXME: mark in red when char count exceeds 160
    $("#length-message").text(length + " characters used (single SMS fits 160)");
});
$('#id_text').triggerHandler('input');

{% endblock functions %}
