{% extends 'base_ftable.html' %}
{% load bootstrap4 %}

{% block title %}New Compose Message{% endblock %}

{% block subheader %}
<strong id="subhdr">Event Page</strong>
{% endblock subheader %}


{% block table_options %}
select: 'os',
order: [[ 3, 'desc' ]],
paging: false,
initComplete: function () {
    var tbl = this.api();

    InitializeRowsBasedOnFormat(tbl);
},
columnDefs: [
    { responsivePriority: 1, targets: [0, 1] },
    { responsivePriority: 5, targets: 2 },
    { responsivePriority: 2, targets: 3 },
    { responsivePriority: 3, targets: 4},
    { responsivePriority: 4, targets: 5},
],
//FIXME: look into using filter tag for sort-order
columns: [
    { data: 'check',
      width: '5px', //FIXME: adjust alignment
      orderable: false,
      className: 'mark-checkbox',
      render: function(data, type, row) {
          return '<div data-id="'+row.id+'"></div>';
      },
    },
    { data: 'name' },
    { data: 'rank' },
    { data: 'roles' },
    { data: 'display_phone' },
    { data: 'display_email' }
],
language: {
      emptyTable: 'No participants selected'
},
{% endblock table_options %}

{% block table_buttons_first %}
{
    text: '<i class="fa fa-address-book"></i> Send Page',
    action: SendPage,
},
{
    text: 'Select All',
    action: SelectAll,
},
{
    text: 'Clear All',
    action: ClearAll,
},
{% endblock table_buttons_first %}

{% block ready_functions %}
table
    .on( 'select', function ( e, dt, type, indices ) {
        var allMarked = true;
        var numRows = indices.length;
        if (numRows > 1) {
            dt.rows(indices).every( function ( rowIdx, tableLoop, rowLoop ) {
                // For multi select - unmark only when every row is marked
                allMarked = allMarked && $(this.nodes()).children().first().hasClass('marked');
            })
        }
        dt.rows(indices)
            .every( function ( rowIdx, tableLoop, rowLoop ) {
                if (numRows > 1) {
                    if (allMarked)
                        $(this.node()).children().first().removeClass('marked');
                    else
                        $(this.node()).children().first().addClass('marked');
                } else {
                    if ($(this.node()).children().first().hasClass('marked')) {
                        $(this.node()).children().first().removeClass('marked');
                        this.deselect();
                    } else
                        $(this.node()).children().first().addClass('marked');
                }
            });
    });

{% endblock ready_functions %}

{% block table_functions %}

const url = new URL(window.location.href);
const eventId = url.searchParams.get('eid');
const periodPosition = url.searchParams.get('OP');
const periodId = url.searchParams.get('period');
const periodFormat = url.searchParams.get('period_format');
const page = url.searchParams.get('page');
const apiUrlMemberRank = '/api/members/?member_rank=';

function InitializeRowsBasedOnFormat(table) {
    //FIXME: this is very slow, need better api
    var url = apiUrlMemberRank;
    $.getJSON(url, null, function( json ) {
        
        var members = JSON.parse($('input[name=members]').val());
        for (var i=0; i<json.length; i++)
        {
            var data = json[i];
            if (members.includes(data.id)) {
                data['check'] = '';
                data['name'] = '<a href="/member/'+data['id']+'">'+data['full_name']+'</a>';
                data['rank'] = '<td data-order="' + data['rank_order'] + '">' + data['rank'] + '</td>';
                data['roles'] = '<td data-order="' + data['role_order'] + '">' + data['roles'] + '</td>';
            
                table.row.add(data).invalidate(); // invalidate needed to force rank and role display
            }
        }

        // not sure why this is required here but it is needed (tried to hoist it without success)
        table.draw().columns.adjust().responsive.recalc();

        if (periodFormat != 'invite')//FIXME
            $('td.mark-checkbox').addClass('marked');

    });
}

function AddRows(table, values) {
    //
    // Add rows based on rank =values[0]
    //
    var url = apiUrlMemberRank+values[0];
    //FIXME: error handling
    $.getJSON(url, null, function( json ) {
        
        for (var i=0; i<json.length; i++)
        {
            var data = json[i];
            data['check'] = '';
            data['name'] = '<a href="/member/'+data['id']+'">'+data['full_name']+'</a>';
            data['rank'] = '<td data-order="' + data['rank_order'] + '">' + data['rank'] + '</td>';
            data['roles'] = '<td data-order="' + data['role_order'] + '">' + data['roles'] + '</td>';
            
            table.row.add(data).invalidate(); // invalidate needed to force rank and role display
        }
        
        // not sure why this is required here but it is needed (tried to hoist it without success)
        table.draw().columns.adjust().responsive.recalc();
    });
}

function RemoveRows(table, values) {
    // Remove rows based on rank
    table.rows(
        function ( idx, data, node ) {
            var rank = data['rank']
            //FIXME: Handle both cases: 'FM' and <td ...>FM</td>
            if (rank[0] == '<')
                rank = data['rank'].match('.*>(.*)<')[1]
            return rank == values[0];
        } )
        .remove();

    table.draw();
}

function SendPage ( e, dt, node, config ) {
    var members = [];
    $('td.mark-checkbox.marked').each(function (i, el) {
        members.push($(this.firstChild).data().id)
    });
    
    if (members.length == 0) {
        alert('Select members before paging them');
        return;
    }
    
    var viaEmail = $('input[name=email]').prop('checked') ;
    var viaSms = $('input[name=phone]').prop('checked');
    var via = '';
    
    if (viaEmail && viaSms) {
        via = '(email, sms)';
    } else if (viaEmail) {
        via = '(email)';
    } else if (viaSms) {
        via = '(sms)';
    } else {
        via = '()';
    }
    var text = $('#id_text').val();
    confirm('Page via '+via+' '+members.length+' members\nMessage: '+text);
    console.log(members);
    
    var data = {};
    data['text'] = text;
    data['format'] = 'page';
    data['period'] = periodId;
    data['period_format'] = periodFormat;
    data['rsvp_template'] = page;
    data['distribution_set'] = [];
    for (var i = 0; i < members.length; i++) {
        data['distribution_set'].push({
          'member': members[i],
          'email': viaEmail,
          'phone': viaSms,
        });
    }
    data = JSON.stringify(data);
    //FIXME: add error handling
    $.ajax({
        method: 'POST',
        contentType: 'application/json',
        url: '/api/message/',
        data: data,
        success: function (response) {
            console.log(response);
            var message_id = response.id;
            location.href='/message/' + message_id + '/';
        },
        error: function (xhr) {
            console.log('Message add failed');
            console.log(xhr);
            alert(xhr.responseText);
            return false;
        }
    })
}

function SelectAll ( e, dt, node, config ) {
    $('td.mark-checkbox').addClass('marked');
}

function ClearAll ( e, dt, node, config ) {
    $('td.mark-checkbox').removeClass('marked');
    table.rows().deselect();
}


function UpdateSubheaderBasedOnSettings(table) {
    // Extract currently selected ranks based on filter
    var showRanks = [];
    $('#filter-rank option').each(function() {
        if (!this.selected) {
            showRanks.push(this.value);
        }
    });

    {% comment %}
    $('#subhdr')[0].innerHTML = ('<a href="/event/' + eventId + '/#OP' + periodPosition + '">' +
                                 '{{ period }}</a>:'+ page +' > Page Participants ('
                                 + showRanks.join(', ') + ')');
    {% endcomment %}
    document.title = '{{ period }} Page';

}

$('#filter-rank').multiSelect({
    // The sense of the multiSelect is inverted: show = deselect, hide = select
    selectableHeader: '<div class="custom-header">Show</div>',
    selectionHeader: '<div class="custom-header">Hide</div>',
    afterSelect: function(values){
        RemoveRows(table,values);
        UpdateSubheaderBasedOnSettings(table);
    },
    afterDeselect: function(values){
        AddRows(table,values);
        UpdateSubheaderBasedOnSettings(table);
    }
})

$('#id_text').after($("<div id='length-message' class='text-muted'>"));
$('#id_text').on('input', function(){
    var length = $('#id_text').val().length + $('#data').data('extra-characters');
    //FIXME: mark in red when char count exceeds 160
    $("#length-message").text(length + " characters used (single SMS fits 160)");
});
$('#id_text').triggerHandler('input');

{% endblock table_functions %}

{% block content %}
<main role="main" class="container">
  <div id="content">
    <form method="post">
      {% csrf_token %}
      {% bootstrap_form form %}
    </form>
  </div>

  <div id="show-filter" style="display: none">
    <select id="filter-rank" multiple="multiple" selectableHeader="Display rank">
      <option value="TM">Technical Member</option>
      <option value="FM">Field Member</option>
      <option value="T">Trainee</option>
      <option value="R">Reserve</option>
      <option value="S">Support</option>
      <option value="A">Associate</option>
      <option value="G" selected >Guest</option>
      <option value="MA" selected >Member Alum</option>
    </select>
  </div>

  <table id="dTbl" class="display table-bordered nowrap" style="width:100%">
    <thead>
      <tr>
        <th></th>
        <th>Name</th><th>Rank</th><th>Roles</th><th>Phone</th><th>eMail</th>
      </tr>
    </thead>

    <tbody></tbody>
  </table>
  <div id='data' class="d-none" data-extra-characters='{{extra_characters}}'></div>
</main>
{% endblock content%}
